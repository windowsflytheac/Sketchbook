<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sketchbook Half-Life 2 Style Menu + Multiplayer + Console</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono&display=swap');

  /* Reset */
  body, html {
    margin: 0; padding: 0; height: 100%;
    background: #000; 
    font-family: 'Roboto Mono', monospace;
    color: #f1a20f; /* HL2 orange */
    overflow: hidden;
    user-select: none;
  }

  /* Valve Intro Video Overlay */
  #valveIntro {
    position: fixed;
    top: 0; left: 0;
    width: 100vw; height: 100vh;
    object-fit: cover;
    background: black;
    z-index: 15000;
  }

  /* HL2-style main menu */
  #menuOverlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: #000000ee;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 11000;
    opacity: 0;
    transition: opacity 0.7s ease;
  }
  #menuOverlay.visible {
    opacity: 1;
  }

  #menuTitle {
    font-size: 4rem;
    font-weight: bold;
    margin-bottom: 2rem;
    text-shadow: 0 0 12px #f1a20f;
  }

  .menu-button {
    background: transparent;
    border: 2px solid #f1a20f;
    color: #f1a20f;
    padding: 1rem 4rem;
    margin: 0.75rem 0;
    font-size: 1.6rem;
    font-weight: 700;
    letter-spacing: 1.2px;
    cursor: pointer;
    width: 280px;
    text-align: center;
    text-transform: uppercase;
    box-shadow: 0 0 15px #f1a20f88;
    transition: background 0.3s ease, color 0.3s ease;
  }
  .menu-button:hover {
    background: #f1a20f;
    color: #000;
    box-shadow: 0 0 30px #f1a20fff;
  }

  /* Loading bar container */
  #progressBarContainer {
    margin-top: 3rem;
    width: 60%;
    height: 24px;
    background: #111;
    border: 2px solid #f1a20f;
    border-radius: 4px;
    overflow: hidden;
    box-shadow: 0 0 15px #f1a20f88 inset;
    display: none;
  }

  /* Loading bar fill */
  #progressBar {
    height: 100%;
    width: 0%;
    background: linear-gradient(90deg, #f1a20f, #ffd65c);
    box-shadow: 0 0 20px #f1a20fff;
    transition: width 0.2s ease;
  }

  /* Gravity gun placeholder container */
  #gravityGunPlaceholder {
    margin-top: 3rem;
    width: 180px;
    height: 180px;
  }

  /* Console styles */
  #console {
    position: fixed;
    bottom: 0; left: 0; right: 0;
    max-height: 40%;
    background: rgba(0,0,0,0.85);
    display: none;
    flex-direction: column;
    padding: 10px;
    overflow-y: auto;
    z-index: 12000;
  }
  #console-output {
    flex-grow: 1;
    overflow-y: auto;
    white-space: pre-wrap;
    font-size: 14px;
    line-height: 1.2em;
    margin-bottom: 5px;
  }
  #console-input {
    font-family: monospace;
    font-size: 14px;
    border: none;
    background: black;
    color: #f1a20f;
    outline: none;
    padding: 5px;
    width: 100%;
    box-sizing: border-box;
  }
</style>

<!-- ThreeJS and dependencies -->
<script src="https://cdn.jsdelivr.net/npm/three@0.153.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.153.0/examples/js/loaders/GLTFLoader.js"></script>

<!-- Sketchbook -->
<script src="build/sketchbook.min.js"></script>

<!-- Photon Multiplayer SDK -->
<script src="https://cdn.jsdelivr.net/npm/photon-sdk@4.1.1/Photon-Javascript_SDK.min.js"></script>
</head>
<body>

<!-- Valve Intro Video -->
<video id="valveIntro" autoplay muted playsinline>
  <source src="valveintro.mp4" type="video/mp4" />
  Your browser does not support the video tag.
</video>

<!-- HL2-style Main Menu -->
<div id="menuOverlay">
  <div id="menuTitle">HALF-LIFE 2</div>
  <button id="startGameBtn" class="menu-button">Start Game</button>
  <button id="loadSaveBtn" class="menu-button">Load Save</button>

  <div id="progressBarContainer">
    <div id="progressBar"></div>
  </div>

  <div id="gravityGunPlaceholder"></div>
</div>

<!-- Console -->
<div id="console">
  <div id="console-output"></div>
  <input id="console-input" autocomplete="off" spellcheck="false" placeholder="Enter command..." />
</div>

<script>
  // Globals
  let weaponGroup = null;
  let consoleActive = false;

  // Elements
  const valveIntro = document.getElementById('valveIntro');
  const menuOverlay = document.getElementById('menuOverlay');
  const progressBarContainer = document.getElementById('progressBarContainer');
  const progressBar = document.getElementById('progressBar');
  const consoleEl = document.getElementById('console');
  const consoleOutput = document.getElementById('console-output');
  const consoleInput = document.getElementById('console-input');

  // Valve intro fade and menu show
  valveIntro.onended = () => {
    valveIntro.style.transition = 'opacity 1s ease';
    valveIntro.style.opacity = '0';
    setTimeout(() => valveIntro.remove(), 1000);
    showMenu();
  };

  // Optionally skip valve intro video
  window.addEventListener('keydown', (e) => {
    if (valveIntro && !valveIntro.ended && (e.key === "Escape" || e.key === " ")) {
      valveIntro.pause();
      valveIntro.dispatchEvent(new Event('ended'));
    }
  });

  // Show HL2-style menu
  function showMenu() {
    menuOverlay.classList.add('visible');
  }

  // Start Game logic with fixed loading bar
  document.getElementById('startGameBtn').onclick = () => {
    progressBarContainer.style.display = 'block';
    progressBar.style.width = '0%';
    menuOverlay.style.pointerEvents = 'none'; // disable buttons

    let loadProgress = 0;
    const world = new Sketchbook.World('build/assets/world.glb');

    const fakeInterval = setInterval(() => {
      loadProgress += Math.random() * 8;
      if (loadProgress > 95) loadProgress = 95;
      progressBar.style.width = loadProgress + '%';
    }, 100);

    world.ready.then(() => {
      clearInterval(fakeInterval);
      progressBar.style.width = '100%';

      // Setup portal gun
      weaponGroup = new THREE.Group();
      world.camera.add(weaponGroup);
      world.scene.add(world.camera);
      weaponGroup.position.set(0.5, -0.7, -1);
      weaponGroup.visible = false;

      const loader = new THREE.GLTFLoader();
      loader.load('build/assets/models/mel_portal_gun.glb', (gltf) => {
        const portalGun = gltf.scene;
        portalGun.scale.set(1.5, 1.5, 1.5);
        weaponGroup.add(portalGun);
      });

      setTimeout(() => {
        progressBarContainer.style.display = 'none';
        menuOverlay.classList.remove('visible');
        menuOverlay.style.pointerEvents = '';
      }, 600);
    });
  };

  // Load Save placeholder
  document.getElementById('loadSaveBtn').onclick = () => {
    alert('Load Save feature not implemented yet.');
  };

  // Console utilities
  function logToConsole(msg) {
    consoleOutput.textContent += msg + '\n';
    consoleOutput.scrollTop = consoleOutput.scrollHeight;
    console.log(msg);
  }

  function toggleConsole() {
    consoleActive = !consoleActive;
    consoleEl.style.display = consoleActive ? 'flex' : 'none';
    if (consoleActive) consoleInput.focus();
  }

  // Console command handler
  function handleCommand(cmd) {
    const args = cmd.trim().split(/\s+/);
    const command = args[0].toLowerCase();

    switch (command) {
      case 'sv_cheats':
        if (args.length < 2) {
          logToConsole('Usage: sv_cheats [0|1|2]');
          break;
        }
        const level = parseInt(args[1], 10);
        if ([0,1,2].includes(level)) {
          cheatsLevel = level;
          logToConsole(`sv_cheats set to ${level}`);
        } else {
          logToConsole('Invalid sv_cheats level. Use 0, 1, or 2.');
        }
        break;

      case 'toggleportalgun':
        if (weaponGroup) {
          weaponGroup.visible = !weaponGroup.visible;
          logToConsole(`Portal gun ${weaponGroup.visible ? 'enabled' : 'disabled'}`);
        }
        break;

      case 'noclip':
        logToConsole('Noclip not implemented yet.');
        break;

      case 'join':
        if (args.length < 2) {
          logToConsole('Usage: join [roomname]');
          break;
        }
        if (!photonClient.isInLobby()) {
          logToConsole('Must be in lobby to join a room.');
          break;
        }
        photonClient.joinRoom(args[1]).then(() => {
          logToConsole(`Joining room ${args[1]}...`);
        }).catch(e => {
          logToConsole(`Failed to join room: ${e.message || e}`);
        });
        break;

      case 'leave':
        if (!photonClient.isInRoom) {
          logToConsole('Not currently in a room.');
          break;
        }
        photonClient.leaveRoom().then(() => {
          logToConsole('Left room.');
        }).catch(e => {
          logToConsole(`Failed to leave room: ${e.message || e}`);
        });
        break;

      case 'host':
        if (args.length < 2) {
          logToConsole('Usage: host [roomname]');
          break;
        }
        if (!photonClient.isInLobby()) {
          logToConsole('Must be in lobby to host a room.');
          break;
        }
        photonClient.createRoom(args[1], { maxPlayers: 8 }).then(() => {
          logToConsole(`Hosting room ${args[1]}...`);
        }).catch(e => {
          logToConsole(`Failed to host room: ${e.message || e}`);
        });
        break;

      case 'help':
        logToConsole('Commands: sv_cheats, toggleportalgun, noclip, join [room], leave, host [room], help');
        break;

      default:
        logToConsole(`Unknown command: ${command}`);
    }
  }

  // Console input event
  consoleInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      const cmd = consoleInput.value;
      consoleInput.value = '';
      logToConsole('> ' + cmd);
      handleCommand(cmd);
      e.preventDefault();
    }
  });

  // Key bindings for console toggle and portal gun toggle
  window.addEventListener('keydown', (e) => {
    if (e.key === '`' || e.key === '~') {
      e.preventDefault();
      toggleConsole();
    } else if (!consoleActive && e.key.toLowerCase() === 'c') {
      if (weaponGroup) {
        weaponGroup.visible = !weaponGroup.visible;
        logToConsole(`Portal gun ${weaponGroup.visible ? 'enabled' : 'disabled'}`);
      }
    }
  });

  // Photon multiplayer setup
  const photonAppId = "0e7ba88d-a481-481c-a32b-2e0dabaa8d7e";
  const photonClient = new Photon.LoadBalancing.LoadBalancingClient(photonAppId, "us");

  photonClient.onStateChange = (state) => {
    logToConsole(`Photon State: ${Photon.LoadBalancing.ConnectionStateToName(state)}`);

    if (state === Photon.LoadBalancing.ConnectionState.ConnectedToMaster) {
      photonClient.joinLobby();
    }
    if (state === Photon.LoadBalancing.ConnectionState.JoinedLobby) {
      logToConsole('Joined lobby, ready for commands.');
    }
    if (state === Photon.LoadBalancing.ConnectionState.JoinedRoom) {
      logToConsole(`Joined room: ${photonClient.myRoomName}`);
    }
  };

  photonClient.connect();

</script>

</body>
</html>
