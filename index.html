<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sketchbook with Valve Intro & Portal Gun</title>
<style>
  body, html {
    margin: 0; padding: 0; height: 100%;
    background: #222;
    font-family: monospace;
    color: white;
    overflow: hidden;
  }
  #valveIntro {
    position: fixed;
    top: 0; left: 0;
    width: 100vw; height: 100vh;
    object-fit: cover;
    background: black;
    z-index: 10000;
  }
  #enableSoundOverlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.8);
    color: #f1a20f;
    font-family: monospace;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 2rem;
    cursor: pointer;
    z-index: 12000;
  }
  #menuOverlay {
    position: fixed;
    top: 10vh; left: 50%; transform: translateX(-50%);
    background: #333;
    padding: 1rem 2rem;
    border-radius: 6px;
    box-shadow: 0 0 12px #f1a20f;
    color: #f1a20f;
    z-index: 9000;
  }
  #menuOverlay button {
    background: transparent;
    border: 2px solid #f1a20f;
    color: #f1a20f;
    padding: 0.5rem 1.5rem;
    margin: 0 0.5rem;
    cursor: pointer;
    font-size: 1rem;
    border-radius: 4px;
  }
  #menuOverlay button:hover {
    background: #f1a20f;
    color: #000;
  }
  #console {
    position: fixed;
    bottom: 0; left: 0; right: 0;
    max-height: 40%;
    background: rgba(0,0,0,0.85);
    display: none;
    flex-direction: column;
    padding: 10px;
    overflow-y: auto;
    z-index: 11000;
  }
  #console-output {
    flex-grow: 1;
    overflow-y: auto;
    white-space: pre-wrap;
    font-size: 14px;
    line-height: 1.2em;
    margin-bottom: 5px;
  }
  #console-input {
    font-family: monospace;
    font-size: 14px;
    border: none;
    background: black;
    color: #f1a20f;
    outline: none;
    padding: 5px;
    width: 100%;
    box-sizing: border-box;
  }
  #lobbyOverlay {
    display:none;
    position: fixed;
    top: 20vh; left: 50%;
    transform: translateX(-50%);
    background: #222;
    border: 2px solid #f1a20f;
    padding: 1rem 2rem;
    border-radius: 8px;
    z-index: 13000;
    color: #f1a20f;
    font-family: monospace;
  }
  #lobbyOverlay input {
    background:#333;
    border:none;
    color:#f1a20f;
    padding:0.5rem;
    width:200px;
    border-radius:4px;
  }
  #lobbyOverlay button {
    margin-left:0.5rem;
    background:none;
    border:2px solid #f1a20f;
    color:#f1a20f;
    padding:0.5rem 1rem;
    cursor:pointer;
    border-radius:4px;
  }
  #lobbyStatus {
    margin-top:0.75rem;
    font-size:0.9rem;
  }
</style>

<script src="https://cdn.jsdelivr.net/npm/three@0.153.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.153.0/examples/js/loaders/GLTFLoader.js"></script>
<script src="https://cdn.jsdelivr.net/npm/photon-javascript-sdk@5.1.0/build/photon.min.js"></script>
<script src="build/sketchbook.min.js"></script>

</head>
<body>

<video id="valveIntro" autoplay muted playsinline>
  <source src="valveintro.mp4" type="video/mp4" />
  Your browser does not support the video tag.
</video>

<audio id="valveIntroAudio" src="valveintro_sound.mp3"></audio>

<div id="enableSoundOverlay">Click to enable sound</div>

<div id="menuOverlay">
  <button id="startGameBtn">Start Game</button>
  <button id="loadSaveBtn">Load Save</button>
</div>

<!-- Lobby UI -->
<div id="lobbyOverlay">
  <div>Photon Lobby</div>
  <input id="roomInput" type="text" placeholder="Room Name" />
  <button id="joinRoomBtn">Join/Create</button>
  <div id="lobbyStatus"></div>
</div>

<div id="console">
  <div id="console-output"></div>
  <input id="console-input" autocomplete="off" spellcheck="false" placeholder="Enter command..." />
</div>

<script>
  let weaponGroup = null;
  let consoleActive = false;

  const valveIntro = document.getElementById('valveIntro');
  const valveIntroAudio = document.getElementById('valveIntroAudio');
  const soundOverlay = document.getElementById('enableSoundOverlay');
  const menuOverlay = document.getElementById('menuOverlay');
  const lobbyOverlay = document.getElementById('lobbyOverlay');
  const roomInput = document.getElementById('roomInput');
  const joinRoomBtn = document.getElementById('joinRoomBtn');
  const lobbyStatus = document.getElementById('lobbyStatus');
  const consoleEl = document.getElementById('console');
  const consoleOutput = document.getElementById('console-output');
  const consoleInput = document.getElementById('console-input');

  // Photon Config
  const APP_ID = "0e7ba88d-a481-481c-a32b-2e0dabaa8d7e"; // <<< REPLACE WITH YOUR APP ID
  const REGION = "us";

  let photonClient = null;
  let currentRoomName = null;

  // Sound enable click
  soundOverlay.addEventListener('click', () => {
    valveIntro.muted = false;
    valveIntro.play();
    valveIntroAudio.play();
    soundOverlay.style.display = 'none';
  });

  valveIntro.onended = () => {
    valveIntro.style.transition = 'opacity 1s ease';
    valveIntro.style.opacity = '0';
    setTimeout(() => valveIntro.remove(), 1000);
    menuOverlay.style.display = 'block';
  };

  // Start Game button shows lobby UI
  document.getElementById('startGameBtn').onclick = () => {
    menuOverlay.style.display = 'none';
    lobbyOverlay.style.display = 'block';
  };

  // Join/Create room logic
  joinRoomBtn.onclick = () => {
    const roomName = roomInput.value.trim();
    if (!roomName) {
      lobbyStatus.textContent = 'Please enter a room name.';
      return;
    }
    currentRoomName = roomName;
    lobbyStatus.textContent = `Connecting to room: ${roomName}...`;

    photonClient = new Photon.LoadBalancing.LoadBalancingClient(REGION, APP_ID);

    photonClient.onStateChange = (state) => {
      console.log("Photon State:", state);
      if (state === Photon.LoadBalancing.ClientState.Joined) {
        lobbyStatus.textContent = `Joined room: ${currentRoomName}`;
        lobbyOverlay.style.display = 'none';
        initializeGameMultiplayer();
      } else if (state === Photon.LoadBalancing.ClientState.Joining) {
        lobbyStatus.textContent = `Joining room: ${currentRoomName}...`;
      } else if (state === Photon.LoadBalancing.ClientState.Disconnected) {
        lobbyStatus.textContent = 'Disconnected. Try again.';
      }
    };

    photonClient.onEvent = (code, content, senderId) => {
      switch(code) {
        case 1: // Gravity Gun sync
          updateGravityGunFromNetwork(content);
          break;
        case 2: // Portal Gun toggle sync
          updatePortalGunFromNetwork(content);
          break;
      }
    };

    photonClient.connect();
    photonClient.joinRoom(currentRoomName).catch(() => {
      photonClient.createRoom(currentRoomName).catch((err) => {
        lobbyStatus.textContent = `Error creating/joining room: ${err}`;
      });
    });
  };

  // Game initialization (loads world and weapons)
  function initializeGameMultiplayer() {
    const world = new Sketchbook.World('build/assets/world.glb');

    weaponGroup = new THREE.Group();
    world.camera.add(weaponGroup);
    world.scene.add(world.camera);
    weaponGroup.position.set(0.5, -0.7, -1);
    weaponGroup.visible = false;

    const loader = new THREE.GLTFLoader();

    // Load Portal Gun
    loader.load('build/assets/models/mel_portal_gun.glb', (gltf) => {
      const portalGun = gltf.scene;
      portalGun.name = "portalGun";
      portalGun.scale.set(1.5, 1.5, 1.5);
      weaponGroup.add(portalGun);
    });

    // Load Gravity Gun
    loader.load('build/assets/models/gravity_gun.glb', (gltf) => {
      const gravityGun = gltf.scene;
      gravityGun.name = "gravityGun";
      gravityGun.scale.set(1.5, 1.5, 1.5);
      gravityGun.visible = false;
      weaponGroup.add(gravityGun);

      // Example: Hook fireGravityGun (connect your actual input here)
      window.fireGravityGun = function(position, rotation) {
        // Your local gravity gun logic here...

        if (photonClient && photonClient.isJoinedToRoom()) {
          photonClient.raiseEvent(1, { position, rotation }, { receivers: Photon.LoadBalancing.ReceiverGroup.Others });
        }
      };
    });
  }

  // Network sync handlers
  function updateGravityGunFromNetwork(data) {
    if (!weaponGroup) return;
    const gravityGun = weaponGroup.children.find(c => c.name === "gravityGun");
    if (gravityGun) {
      gravityGun.position.set(data.position.x, data.position.y, data.position.z);
      gravityGun.rotation.set(data.rotation.x, data.rotation.y, data.rotation.z);
    }
  }

  function updatePortalGunFromNetwork(data) {
    if (!weaponGroup) return;
    weaponGroup.visible = data.visible;
  }

  // Load Save placeholder
  document.getElementById('loadSaveBtn').onclick = () => {
    alert('Load Save not implemented yet.');
  };

  // Console helpers and commands
  function logToConsole(msg) {
    consoleOutput.textContent += msg + '\n';
    consoleOutput.scrollTop = consoleOutput.scrollHeight;
    console.log(msg);
  }

  function toggleConsole() {
    consoleActive = !consoleActive;
    consoleEl.style.display = consoleActive ? 'flex' : 'none';
    if (consoleActive) consoleInput.focus();
  }

  function handleCommand(cmd) {
    const c = cmd.toLowerCase();
    if (c === 'toggleportalgun') {
      if (weaponGroup) {
        weaponGroup.visible = !weaponGroup.visible;
        if (photonClient && photonClient.isJoinedToRoom()) {
          photonClient.raiseEvent(2, { visible: weaponGroup.visible }, { receivers: Photon.LoadBalancing.ReceiverGroup.Others });
        }
        logToConsole(`Portal gun ${weaponGroup.visible ? 'enabled' : 'disabled'}`);
      }
    } else if (c === 'help') {
      logToConsole('Commands: toggleportalgun, help');
    } else {
      logToConsole(`Unknown command: ${cmd}`);
    }
  }

  consoleInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      const cmd = consoleInput.value.trim();
      consoleInput.value = '';
      logToConsole('> ' + cmd);
      handleCommand(cmd);
      e.preventDefault();
    }
  });

  // Keybindings
  window.addEventListener('keydown', (e) => {
    if (e.key === '`' || e.key === '~') {
      e.preventDefault();
      toggleConsole();
    } else if (!consoleActive && e.key.toLowerCase() === 'c') {
      if (weaponGroup) {
        weaponGroup.visible = !weaponGroup.visible;
        if (photonClient && photonClient.isJoinedToRoom()) {
          photonClient.raiseEvent(2, { visible: weaponGroup.visible }, { receivers: Photon.LoadBalancing.ReceiverGroup.Others });
        }
        logToConsole(`Portal gun ${weaponGroup.visible ? 'enabled' : 'disabled'}`);
      }
    }
  });
</script>

</body>
</html>
