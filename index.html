<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sketchbook 3D Three.js (Build 230)</title>

<!-- League Gothic font -->
<link href="https://fonts.googleapis.com/css2?family=League+Gothic&display=swap" rel="stylesheet" />

<style>
  /* Global styling */
  body, html {
    margin: 0; padding: 0; height: 100%;
    background: #222;
    font-family: 'League Gothic', sans-serif;
    color: white;
    overflow: hidden;
  }
  /* Valve intro video */
  #valveIntro {
    position: fixed;
    top: 0; left: 0;
    width: 100vw; height: 100vh;
    object-fit: cover;
    background: black;
    z-index: 10000;
  }
  /* Sound enable overlay */
  #enableSoundOverlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.8);
    color: #f1a20f;
    font-family: 'League Gothic', sans-serif;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 2rem;
    cursor: pointer;
    z-index: 12000;
  }
  /* Menu overlay */
  #menuOverlay {
    position: fixed;
    top: 10vh; left: 50%;
    transform: translateX(-50%);
    background: #333;
    padding: 1rem 2rem;
    border-radius: 6px;
    box-shadow: 0 0 12px #f1a20f;
    color: #f1a20f;
    z-index: 9000;
    text-align: center;
  }
  #menuOverlay button {
    background: transparent;
    border: 2px solid #f1a20f;
    color: #f1a20f;
    padding: 0.5rem 1.5rem;
    margin: 0 0.5rem;
    cursor: pointer;
    font-size: 1rem;
    border-radius: 4px;
    font-family: 'League Gothic', sans-serif;
  }
  #menuOverlay button:hover {
    background: #f1a20f;
    color: #000;
  }
  /* Console styling */
  #console {
    position: fixed;
    bottom: 0; left: 0; right: 0;
    max-height: 40%;
    background: rgba(0,0,0,0.85);
    display: none;
    flex-direction: column;
    padding: 10px;
    overflow-y: auto;
    z-index: 11000;
    font-family: monospace;
  }
  #console-output {
    flex-grow: 1;
    overflow-y: auto;
    white-space: pre-wrap;
    font-size: 14px;
    line-height: 1.2em;
    margin-bottom: 5px;
  }
  #console-input {
    font-family: monospace;
    font-size: 14px;
    border: none;
    background: black;
    color: #f1a20f;
    outline: none;
    padding: 5px;
    width: 100%;
    box-sizing: border-box;
  }
  /* Lobby overlay */
  #lobbyOverlay {
    position: fixed;
    top: 20vh; left: 50%;
    transform: translateX(-50%);
    background: #111;
    border: 2px solid #f1a20f;
    border-radius: 8px;
    padding: 1rem 2rem;
    color: #f1a20f;
    z-index: 9500;
    display: none;
    width: 300px;
    text-align: center;
    font-family: 'League Gothic', sans-serif;
  }
  #lobbyOverlay input, #lobbyOverlay button {
    margin: 0.5rem 0;
    padding: 0.5rem;
    font-family: 'League Gothic', sans-serif;
    font-size: 1rem;
    border-radius: 4px;
    border: 1px solid #f1a20f;
    background: #222;
    color: #f1a20f;
  }
  #lobbyOverlay button {
    cursor: pointer;
    border: 2px solid #f1a20f;
  }
  #lobbyOverlay button:hover {
    background: #f1a20f;
    color: #000;
  }
  /* Three.js build label */
  #threejsLabel {
    position: fixed;
    top: 8px;
    right: 12px;
    font-family: 'League Gothic', sans-serif;
    color: #f1a20f;
    font-size: 0.85rem;
    z-index: 13000;
    user-select: none;
    pointer-events: none;
    text-shadow: 0 0 4px #f1a20f;
  }
</style>

<script src="https://cdn.jsdelivr.net/npm/three@0.153.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.153.0/examples/js/loaders/GLTFLoader.js"></script>
<script src="build/sketchbook.min.js"></script>

</head>
<body>

<div id="threejsLabel">Three.js 24 (Build 230)</div>

<video id="valveIntro" autoplay muted playsinline>
  <source src="valveintro.mp4" type="video/mp4" />
  Your browser does not support the video tag.
</video>

<audio id="valveIntroAudio" src="valveintro_sound.mp3"></audio>

<div id="enableSoundOverlay">Click to enable sound</div>

<div id="menuOverlay">
  <button id="startGameBtn">Start Game</button>
  <button id="loadSaveBtn">Load Save</button>
  <button id="showLobbyBtn">Multiplayer Lobby</button>
</div>

<div id="lobbyOverlay">
  <h2>Multiplayer Lobby</h2>
  <input id="roomInput" type="text" placeholder="Room name" />
  <button id="joinRoomBtn">Join Room</button>
  <button id="closeLobbyBtn">Close</button>
  <div id="lobbyStatus" style="margin-top:10px; font-size:0.9rem; min-height: 1.5em;"></div>
</div>

<div id="console">
  <div id="console-output"></div>
  <input id="console-input" autocomplete="off" spellcheck="false" placeholder="Enter command..." />
</div>

<script>
  let weaponGroup = null;
  let consoleActive = false;
  let world = null;
  let photonClient = null;

  const valveIntro = document.getElementById('valveIntro');
  const valveIntroAudio = document.getElementById('valveIntroAudio');
  const soundOverlay = document.getElementById('enableSoundOverlay');
  const menuOverlay = document.getElementById('menuOverlay');
  const consoleEl = document.getElementById('console');
  const consoleOutput = document.getElementById('console-output');
  const consoleInput = document.getElementById('console-input');
  const lobbyOverlay = document.getElementById('lobbyOverlay');
  const showLobbyBtn = document.getElementById('showLobbyBtn');
  const closeLobbyBtn = document.getElementById('closeLobbyBtn');
  const joinRoomBtn = document.getElementById('joinRoomBtn');
  const roomInput = document.getElementById('roomInput');
  const lobbyStatus = document.getElementById('lobbyStatus');

  // Enable audio on user click (required for autoplay sound)
  soundOverlay.addEventListener('click', () => {
    valveIntro.muted = false;
    valveIntro.play();
    valveIntroAudio.play();
    soundOverlay.style.display = 'none';
  });

  // Valve intro video ended - remove video and show menu
  valveIntro.onended = () => {
    valveIntro.style.transition = 'opacity 1s ease';
    valveIntro.style.opacity = '0';
    setTimeout(() => valveIntro.remove(), 1000);
    menuOverlay.style.display = 'block';
  };

  // Single Player start
  document.getElementById('startGameBtn').onclick = () => {
    menuOverlay.style.display = 'none';

    world = new Sketchbook.World('build/assets/world.glb');

    weaponGroup = new THREE.Group();
    world.camera.add(weaponGroup);
    world.scene.add(world.camera);
    weaponGroup.position.set(0.5, -0.7, -1);
    weaponGroup.visible = false;

    const loader = new THREE.GLTFLoader();

    loader.load('build/assets/models/mel_portal_gun.glb', (gltf) => {
      const portalGun = gltf.scene;
      portalGun.scale.set(1.5, 1.5, 1.5);
      weaponGroup.add(portalGun);
    });

    loader.load('build/assets/models/gravitygun/gravitygun.glb', (gltf) => {
      const gravityGun = gltf.scene;
      gravityGun.scale.set(1.5, 1.5, 1.5);
      weaponGroup.add(gravityGun);
    });

    weaponGroup.visible = true;
  };

  // Load Save placeholder
  document.getElementById('loadSaveBtn').onclick = () => {
    alert('Load Save not implemented yet.');
  };

  // Console helpers
  function logToConsole(msg) {
    consoleOutput.textContent += msg + '\n';
    consoleOutput.scrollTop = consoleOutput.scrollHeight;
    console.log(msg);
  }
  function toggleConsole() {
    consoleActive = !consoleActive;
    consoleEl.style.display = consoleActive ? 'flex' : 'none';
    if (consoleActive) consoleInput.focus();
  }
  function handleCommand(cmd) {
    const c = cmd.toLowerCase();
    if (c === 'toggleportalgun') {
      if (weaponGroup) {
        weaponGroup.visible = !weaponGroup.visible;
        logToConsole(`Portal gun ${weaponGroup.visible ? 'enabled' : 'disabled'}`);
      }
    } else if (c === 'help') {
      logToConsole('Commands: toggleportalgun, help');
    } else {
      logToConsole(`Unknown command: ${cmd}`);
    }
  }
  consoleInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      const cmd = consoleInput.value.trim();
      consoleInput.value = '';
      logToConsole('> ' + cmd);
      handleCommand(cmd);
      e.preventDefault();
    }
  });
  window.addEventListener('keydown', (e) => {
    if (e.key === '`' || e.key === '~') {
      e.preventDefault();
      toggleConsole();
    } else if (!consoleActive && e.key.toLowerCase() === 'c') {
      if (weaponGroup) {
        weaponGroup.visible = !weaponGroup.visible;
        logToConsole(`Portal gun ${weaponGroup.visible ? 'enabled' : 'disabled'}`);
      }
    }
  });

  // Lobby UI toggle
  showLobbyBtn.addEventListener('click', () => {
    lobbyOverlay.style.display = 'block';
  });
  closeLobbyBtn.addEventListener('click', () => {
    lobbyOverlay.style.display = 'none';
    lobbyStatus.textContent = '';
  });

  // Photon connection and room join with improved state handling
  joinRoomBtn.addEventListener('click', () => {
    const roomName = roomInput.value.trim();
    if (!roomName) {
      lobbyStatus.textContent = 'Please enter a room name.';
      return;
    }
    lobbyStatus.textContent = 'Connecting...';

    if (!photonClient) {
      photonClient = new Photon.LoadBalancing.LoadBalancingClient('0e7ba88d-a481-481c-a32b-2e0dabaa8d7e', 'us');

      photonClient.onError = (errorCode, errorMsg) => {
        lobbyStatus.textContent = `Error: ${errorMsg} (${errorCode})`;
        logToConsole(`Photon Error: ${errorMsg} (${errorCode})`);
      };

      photonClient.onJoinRoom = () => {
        lobbyStatus.textContent = `Joined room: ${roomName}`;
        logToConsole(`Joined room: ${roomName}`);
      };

      photonClient.onLeaveRoom = () => {
        lobbyStatus.textContent = 'Left room';
        logToConsole('Left room');
      };

      photonClient.onStateChange = (state) => {
        logToConsole(`Photon state: ${state}`);
      };
    }

    const State = Photon.LoadBalancing.LoadBalancingClient.State;

    function connectAndJoin() {
      if (photonClient.state === State.Disconnected || photonClient.state === State.Uninitialized) {
        photonClient.connect();
        logToConsole('Photon connecting...');
      }

      // Poll until connected to master server before joining room
      const waitForConnection = setInterval(() => {
        if (photonClient.state === State.ConnectedToMasterserver) {
          photonClient.joinRoom(roomName).catch((e) => {
            lobbyStatus.textContent = 'Failed to join room.';
            logToConsole('Failed to join room: ' + e);
          });
          clearInterval(waitForConnection);
        }
      }, 200);
    }

    connectAndJoin();
  });
</script>

</body>
</html>
