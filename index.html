<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sketchbook 3D Three.js (Build Selector Multiplayer)</title>

<!-- League Gothic font placeholder -->
<link href="https://fonts.googleapis.com/css2?family=League+Gothic&display=swap" rel="stylesheet" />

<style>
  body, html {
    margin: 0; padding: 0; height: 100%;
    background: #222;
    font-family: 'League Gothic', monospace, monospace;
    color: white;
    overflow: hidden;
  }
  #valveIntro {
    position: fixed;
    top: 0; left: 0;
    width: 100vw; height: 100vh;
    object-fit: cover;
    background: black;
    z-index: 10000;
  }
  #enableSoundOverlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.8);
    color: #f1a20f;
    font-family: 'League Gothic', monospace;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 2rem;
    cursor: pointer;
    z-index: 12000;
  }
  #menuOverlay {
    position: fixed;
    top: 10vh; left: 50%; transform: translateX(-50%);
    background: #333;
    padding: 1rem 2rem;
    border-radius: 6px;
    box-shadow: 0 0 12px #f1a20f;
    color: #f1a20f;
    z-index: 9000;
    font-family: 'League Gothic', monospace;
  }
  #menuOverlay button, select {
    background: transparent;
    border: 2px solid #f1a20f;
    color: #f1a20f;
    padding: 0.5rem 1.5rem;
    margin: 0 0.5rem 0.5rem 0;
    cursor: pointer;
    font-size: 1rem;
    border-radius: 4px;
    font-family: 'League Gothic', monospace;
  }
  #menuOverlay button:hover, select:hover {
    background: #f1a20f;
    color: #000;
  }
  #console {
    position: fixed;
    bottom: 0; left: 0; right: 0;
    max-height: 40%;
    background: rgba(0,0,0,0.85);
    display: none;
    flex-direction: column;
    padding: 10px;
    overflow-y: auto;
    z-index: 11000;
    font-family: 'League Gothic', monospace;
  }
  #console-output {
    flex-grow: 1;
    overflow-y: auto;
    white-space: pre-wrap;
    font-size: 14px;
    line-height: 1.2em;
    margin-bottom: 5px;
  }
  #console-input {
    font-family: 'League Gothic', monospace;
    font-size: 14px;
    border: none;
    background: black;
    color: #f1a20f;
    outline: none;
    padding: 5px;
    width: 100%;
    box-sizing: border-box;
  }
  #threejsLabel {
    position: fixed;
    top: 8px;
    right: 12px;
    font-family: 'League Gothic', monospace;
    color: #f1a20f;
    font-size: 0.85rem;
    z-index: 13000;
    user-select: none;
    pointer-events: none;
    text-shadow: 0 0 4px #f1a20f;
  }
  #buildSelector {
    position: fixed;
    top: 8px;
    left: 12px;
    color: #f1a20f;
    font-family: 'League Gothic', monospace;
    font-size: 0.9rem;
    z-index: 13000;
  }
  #lobbyOverlay {
    display: none;
    position: fixed;
    top: 20vh; left: 50%;
    transform: translateX(-50%);
    background: #333;
    padding: 1rem 2rem;
    border-radius: 6px;
    box-shadow: 0 0 12px #f1a20f;
    color: #f1a20f;
    z-index: 14000;
    font-family: 'League Gothic', monospace;
    width: 300px;
  }
  #lobbyOverlay h2 {
    margin-top: 0;
    font-size: 1.2rem;
  }
  #lobbyOverlay input, #lobbyOverlay button {
    font-family: 'League Gothic', monospace;
    font-size: 1rem;
    margin-top: 0.5rem;
    width: 100%;
    box-sizing: border-box;
  }
  #lobbyStatus {
    margin-top: 10px;
    font-size: 0.9rem;
    min-height: 1.5em;
    white-space: pre-wrap;
  }
</style>
</head>
<body>

<video id="valveIntro" autoplay muted playsinline>
  <source src="valveintro.mp4" type="video/mp4" />
  Your browser does not support the video tag.
</video>

<audio id="valveIntroAudio" src="valveintro_sound.mp3"></audio>

<div id="enableSoundOverlay">Click to enable sound</div>

<div id="menuOverlay">
  <label for="buildSelect">Select Build:</label>
  <select id="buildSelect" title="Choose your Sketchbook 3D build version">
    <option value="alpha_0.12">Alpha 0.12 (No weapons)</option>
    <option value="beta_2.7">Beta 2.7</option>
    <option value="beta_18.2">Beta 18.2</option>
    <option value="beta_24.2" selected>Beta 24.2 (Full weapons)</option>
  </select>
  <br/>
  <button id="startGameBtn">Start Game</button>
  <button id="loadSaveBtn">Load Save</button>
  <button id="showLobbyBtn">Multiplayer Lobby</button>
</div>

<div id="lobbyOverlay">
  <h2>Multiplayer Lobby</h2>
  <input id="roomInput" type="text" placeholder="Room name" />
  <button id="joinRoomBtn">Join Room</button>
  <button id="closeLobbyBtn">Close</button>
  <div id="lobbyStatus"></div>
</div>

<div id="console">
  <div id="console-output"></div>
  <input id="console-input" autocomplete="off" spellcheck="false" placeholder="Enter command..." />
</div>

<div id="threejsLabel">Three.js: Source Beta 24.2 (Full weapons)</div>

<script>
  // Build versions configuration
  const builds = {
    'alpha_0.12': {
      url: 'build/threejsAlpha012/three.min.js',
      label: 'Three.js: Source Alpha 0.12 (No weapons)',
      loadPortalGun: false,
      loadGravityGun: false,
    },
    'beta_2.7': {
      url: 'build/threejsBeta27/three.min.js',
      label: 'Three.js: Source Beta 2.7',
      loadPortalGun: true,
      loadGravityGun: false,
    },
    'beta_18.2': {
      url: 'build/threejsBeta182/three.min.js',
      label: 'Three.js: Source Beta 18.2',
      loadPortalGun: true,
      loadGravityGun: false,
    },
    'beta_24.2': {
      url: 'build/threejsBeta242/three.min.js',
      label: 'Three.js: Source Beta 24.2 (Full weapons)',
      loadPortalGun: true,
      loadGravityGun: true,
    }
  };

  // DOM references
  const valveIntro = document.getElementById('valveIntro');
  const valveIntroAudio = document.getElementById('valveIntroAudio');
  const soundOverlay = document.getElementById('enableSoundOverlay');
  const menuOverlay = document.getElementById('menuOverlay');
  const buildSelect = document.getElementById('buildSelect');
  const threejsLabel = document.getElementById('threejsLabel');
  const loadSaveBtn = document.getElementById('loadSaveBtn');
  const startGameBtn = document.getElementById('startGameBtn');
  const showLobbyBtn = document.getElementById('showLobbyBtn');
  const lobbyOverlay = document.getElementById('lobbyOverlay');
  const closeLobbyBtn = document.getElementById('closeLobbyBtn');
  const joinRoomBtn = document.getElementById('joinRoomBtn');
  const roomInput = document.getElementById('roomInput');
  const lobbyStatus = document.getElementById('lobbyStatus');
  const consoleEl = document.getElementById('console');
  const consoleOutput = document.getElementById('console-output');
  const consoleInput = document.getElementById('console-input');

  // Globals
  let weaponGroup = null;
  let world = null;
  let consoleActive = false;
  let photonClient = null;

  // Enable audio on click
  soundOverlay.addEventListener('click', () => {
    valveIntro.muted = false;
    valveIntro.play();
    valveIntroAudio.play();
    soundOverlay.style.display = 'none';
  });

  // Valve intro end
  valveIntro.onended = () => {
    valveIntro.style.transition = 'opacity 1s ease';
    valveIntro.style.opacity = '0';
    setTimeout(() => valveIntro.remove(), 1000);
    menuOverlay.style.display = 'block';
  };

  // Console helpers
  function logToConsole(msg) {
    consoleOutput.textContent += msg + '\n';
    consoleOutput.scrollTop = consoleOutput.scrollHeight;
    console.log(msg);
  }
  function toggleConsole() {
    consoleActive = !consoleActive;
    consoleEl.style.display = consoleActive ? 'flex' : 'none';
    if (consoleActive) consoleInput.focus();
  }

  consoleInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      const cmd = consoleInput.value.trim();
      consoleInput.value = '';
      logToConsole('> ' + cmd);
      handleCommand(cmd);
      e.preventDefault();
    }
  });

  window.addEventListener('keydown', (e) => {
    if (e.key === '`' || e.key === '~') {
      e.preventDefault();
      toggleConsole();
    } else if (!consoleActive && e.key.toLowerCase() === 'c') {
      if (weaponGroup) {
        weaponGroup.visible = !weaponGroup.visible;
        logToConsole(`Portal gun ${weaponGroup.visible ? 'enabled' : 'disabled'}`);
      }
    }
  });

  // Console command handler (example)
  function handleCommand(cmd) {
    const c = cmd.toLowerCase();
    if (c === 'toggleportalgun') {
      if (weaponGroup) {
        weaponGroup.visible = !weaponGroup.visible;
        logToConsole(`Portal gun ${weaponGroup.visible ? 'enabled' : 'disabled'}`);
      }
    } else if (c === 'help') {
      logToConsole('Commands: toggleportalgun, help');
    } else {
      logToConsole(`Unknown command: ${cmd}`);
    }
  }

  // Function to dynamically load scripts
  function loadScript(url) {
    return new Promise((resolve, reject) => {
      const existing = document.querySelector(`script[src="${url}"]`);
      if (existing) {
        resolve();
        return;
      }
      const script = document.createElement('script');
      script.src = url;
      script.onload = () => resolve();
      script.onerror = () => reject(`Failed to load script: ${url}`);
      document.head.appendChild(script);
    });
  }

  // Load Three.js and GLTFLoader for selected build
  async function loadBuildScripts(buildKey) {
    const build = builds[buildKey];
    // Remove old three.js and GLTFLoader scripts
    document.querySelectorAll('script[data-dynamic]').forEach(s => s.remove());

    // Load three.js for this build
    await new Promise((resolve, reject) => {
      const script = document.createElement('script');
      script.src = build.url;
      script.dataset.dynamic = 'true';
      script.onload = resolve;
      script.onerror = reject;
      document.head.appendChild(script);
    });

    // Load GLTFLoader - always from cdn to keep consistent
    await loadScript('https://cdn.jsdelivr.net/npm/three@0.153.0/examples/js/loaders/GLTFLoader.js');

    // Update label
    threejsLabel.textContent = build.label;
  }

  // Start Game function
  async function startGame() {
    const buildKey = buildSelect.value;
    const build = builds[buildKey];
    try {
      await loadBuildScripts(buildKey);
    } catch (e) {
      alert('Error loading build scripts: ' + e);
      return;
    }

    menuOverlay.style.display = 'none';

    world = new Sketchbook.World('build/assets/world.glb');

    weaponGroup = new THREE.Group();
    world.camera.add(weaponGroup);
    world.scene.add(world.camera);
    weaponGroup.position.set(0.5, -0.7, -1);
    weaponGroup.visible = false;

    const loader = new THREE.GLTFLoader();

    if (build.loadPortalGun) {
      loader.load('build/assets/models/mel_portal_gun.glb', (gltf) => {
        const portalGun = gltf.scene;
        portalGun.scale.set(1.5, 1.5, 1.5);
        weaponGroup.add(portalGun);
      });
    }

    if (build.loadGravityGun) {
      loader.load('build/assets/models/gravitygun/gravitygun.glb', (gltf) => {
        const gravityGun = gltf.scene;
        gravityGun.scale.set(1.5, 1.5, 1.5);
        weaponGroup.add(gravityGun);
      });
    }

    weaponGroup.visible = build.loadPortalGun || build.loadGravityGun;

    logToConsole(`Started game with build: ${build.label}`);
  }

  startGameBtn.onclick = startGame;

  // Load Save placeholder
  loadSaveBtn.onclick = () => {
    alert('Load Save not implemented yet.');
  };

  // Multiplayer Lobby UI
  showLobbyBtn.onclick = () => {
    lobbyOverlay.style.display = 'block';
  };
  closeLobbyBtn.onclick = () => {
    lobbyOverlay.style.display = 'none';
    lobbyStatus.textContent = '';
  };

  // Photon Multiplayer Client Setup
  // Single shared photon client for all builds
  const photonAppId = '0e7ba88d-a481-481c-a32b-2e0dabaa8d7e'; // example appId
  const photonRegion = 'us';

  joinRoomBtn.onclick = () => {
    const roomName = roomInput.value.trim();
    if (!roomName) {
      lobbyStatus.textContent = 'Please enter a room name.';
      return;
    }
    lobbyStatus.textContent = `Connecting to room "${roomName}"...`;

    if (!photonClient) {
      photonClient = new Photon.LoadBalancing.LoadBalancingClient(photonAppId, photonRegion);

      photonClient.onError = (code, msg) => {
        lobbyStatus.textContent = `Error: ${msg} (${code})`;
        logToConsole(`Photon Error: ${msg} (${code})`);
      };

      photonClient.onJoinRoom = () => {
        lobbyStatus.textContent = `Joined room: ${roomName}`;
        logToConsole(`Joined room: ${roomName}`);
      };

      photonClient.onLeaveRoom = () => {
        lobbyStatus.textContent = 'Left room';
        logToConsole('Left room');
      };

      photonClient.onStateChange = (state) => {
        logToConsole(`Photon state: ${state}`);
      };
    }

    const State = Photon.LoadBalancing.LoadBalancingClient.State;

    function connectAndJoin() {
      if (photonClient.state === State.Disconnected || photonClient.state === State.Uninitialized) {
        photonClient.connect();
        logToConsole('Photon connecting...');
      }

      const waitForConnection = setInterval(() => {
        if (photonClient.state === State.ConnectedToMasterserver) {
          photonClient.joinRoom(roomName).catch((e) => {
            lobbyStatus.textContent = 'Failed to join room.';
            logToConsole('Failed to join room: ' + e);
          });
          clearInterval(waitForConnection);
        }
      }, 200);
    }

    connectAndJoin();
  };
</script>

</body>
</html>
