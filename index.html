<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sketchbook Source + Portal Gun + Photon</title>
  <style>
    body { margin: 0; overflow: hidden; background: #111; color: #eee; font-family: monospace; }
    #console {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      max-height: 40%;
      background: rgba(0,0,0,0.85);
      color: #0f0;
      font-size: 14px;
      font-family: monospace;
      overflow-y: auto;
      padding: 10px;
      display: none;
      flex-direction: column;
      z-index: 9999;
    }
    #console-output {
      flex-grow: 1;
      overflow-y: auto;
      white-space: pre-wrap;
      margin-bottom: 5px;
    }
    #console-input {
      border: none;
      outline: none;
      background: black;
      color: #0f0;
      font-family: monospace;
      font-size: 14px;
      padding: 5px;
      width: 100%;
      box-sizing: border-box;
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/three@0.153.0/build/three.min.js"></script>
  <script src="https://unpkg.com/three@0.153.0/examples/js/loaders/GLTFLoader.js"></script>
  <script src="build/sketchbook.min.js"></script>

  <!-- Photon SDK CDN -->
  <script src="https://cdn.jsdelivr.net/npm/photon-sdk@4.1.1/Photon-Javascript_SDK.min.js"></script>
</head>
<body>
  <div id="console">
    <div id="console-output"></div>
    <input id="console-input" type="text" autocomplete="off" placeholder="Enter command..." />
  </div>

  <script>
    const photonAppId = "0e7ba88d-a481-481c-a32b-2e0dabaa8d7e";
    const photonClient = new Photon.LoadBalancing.LoadBalancingClient(photonAppId, "us");

    // Console DOM elements
    const consoleEl = document.getElementById('console');
    const consoleOutput = document.getElementById('console-output');
    const consoleInput = document.getElementById('console-input');

    let consoleActive = false;
    let cheatsLevel = 0;
    let weaponGroup = null;

    // Logging helper
    function logToConsole(msg) {
      consoleOutput.textContent += msg + '\n';
      consoleOutput.scrollTop = consoleOutput.scrollHeight;
    }

    // Toggle console visibility
    function toggleConsole() {
      consoleActive = !consoleActive;
      consoleEl.style.display = consoleActive ? 'flex' : 'none';
      if (consoleActive) consoleInput.focus();
    }

    // Handle console commands
    function handleCommand(cmd) {
      const args = cmd.trim().split(/\s+/);
      const command = args[0].toLowerCase();

      switch(command) {
        case 'sv_cheats':
          if (args.length < 2) {
            logToConsole('Usage: sv_cheats [0|1|2]');
            return;
          }
          const level = parseInt(args[1], 10);
          if ([0,1,2].includes(level)) {
            cheatsLevel = level;
            logToConsole(`sv_cheats set to ${level}`);
          } else {
            logToConsole('Invalid sv_cheats level. Use 0, 1, or 2.');
          }
          break;

        case 'toggleportalgun':
          if (weaponGroup) {
            weaponGroup.visible = !weaponGroup.visible;
            logToConsole('Portal gun ' + (weaponGroup.visible ? 'enabled' : 'disabled'));
          }
          break;

        case 'noclip':
          if (cheatsLevel < 1) {
            logToConsole('noclip requires sv_cheats 1 or higher');
          } else {
            logToConsole('Noclip toggled (stub)');
            // Implement noclip here
          }
          break;

        case 'join':
          if (args.length < 2) {
            logToConsole('Usage: join [roomname]');
            break;
          }
          const joinRoomName = args[1];
          photonClient.joinRoom(joinRoomName).then(() => {
            logToConsole(`Joining room ${joinRoomName}...`);
          }).catch((e) => {
            logToConsole(`Failed to join room ${joinRoomName}: ${e.message || e}`);
          });
          break;

        case 'leave':
          photonClient.leaveRoom().then(() => {
            logToConsole('Left room.');
          }).catch((e) => {
            logToConsole(`Failed to leave room: ${e.message || e}`);
          });
          break;

        case 'host':
          if (args.length < 2) {
            logToConsole('Usage: host [servername]');
            break;
          }
          const hostRoomName = args[1];
          photonClient.createRoom(hostRoomName).then(() => {
            logToConsole(`Hosting room ${hostRoomName}...`);
          }).catch((e) => {
            logToConsole(`Failed to host room ${hostRoomName}: ${e.message || e}`);
          });
          break;

        case 'help':
          logToConsole('Available commands: sv_cheats, toggleportalgun, noclip, join [room], leave, host [room], help');
          break;

        default:
          logToConsole(`Unknown command: ${command}`);
      }
    }

    // Keyboard input handling
    window.addEventListener('keydown', (e) => {
      if (e.key === '`' || e.key === '~') {
        toggleConsole();
        e.preventDefault();
      } else if (consoleActive && e.key === 'Enter') {
        const cmd = consoleInput.value;
        consoleInput.value = '';
        logToConsole('> ' + cmd);
        handleCommand(cmd);
        e.preventDefault();
      } else if (!consoleActive && e.key.toLowerCase() === 'c') {
        if (weaponGroup) weaponGroup.visible = !weaponGroup.visible;
      }
    });

    // Initialize Sketchbook world
    const world = new Sketchbook.World('build/assets/world.glb');

    world.ready.then(() => {
      const scene = world.scene;
      const camera = world.camera;

      weaponGroup = new THREE.Group();
      camera.add(weaponGroup);
      scene.add(camera);
      weaponGroup.position.set(0.5, -0.7, -1);
      weaponGroup.visible = false;

      const loader = new THREE.GLTFLoader();
      loader.load('build/assets/models/mel_portal_gun.glb', (gltf) => {
        const portalGun = gltf.scene;
        portalGun.scale.set(1.5, 1.5, 1.5);
        weaponGroup.add(portalGun);
      });
    });

    photonClient.onStateChange = (state) => {
      logToConsole(`Photon State: ${Photon.LoadBalancing.ConnectionStateToName(state)}`);
      console.log('Photon state:', Photon.LoadBalancing.ConnectionStateToName(state));
    };

    photonClient.connect();
  </script>
</body>
</html>
