<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sketchbook Multiplayer + Portal Gun + Source Console</title>
  <style>
    body {
      margin: 0; overflow: hidden; background: #111; color: #0f0; font-family: monospace;
    }
    #console {
      position: fixed;
      bottom: 0; left: 0; right: 0;
      max-height: 40%;
      background: rgba(0,0,0,0.85);
      display: none;
      flex-direction: column;
      padding: 10px;
      overflow-y: auto;
      z-index: 10000;
    }
    #console-output {
      flex-grow: 1;
      overflow-y: auto;
      white-space: pre-wrap;
      font-size: 14px;
      line-height: 1.2em;
      margin-bottom: 5px;
    }
    #console-input {
      font-family: monospace;
      font-size: 14px;
      border: none;
      background: black;
      color: #0f0;
      outline: none;
      padding: 5px;
      width: 100%;
      box-sizing: border-box;
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/three@0.153.0/build/three.min.js"></script>
  <script src="https://unpkg.com/three@0.153.0/examples/js/loaders/GLTFLoader.js"></script>
  <script src="build/sketchbook.min.js"></script>

  <!-- Photon SDK CDN -->
  <script src="https://cdn.jsdelivr.net/npm/photon-sdk@4.1.1/Photon-Javascript_SDK.min.js"></script>
</head>
<body>
  <div id="console" style="display: none; flex-direction: column;">
    <div id="console-output"></div>
    <input id="console-input" autocomplete="off" spellcheck="false" placeholder="Enter command..." />
  </div>

  <script>
    // *** ORIGINAL SKETCHBOOK WORLD SETUP (KEEP THIS ON TOP) ***
    const world = new Sketchbook.World('build/assets/world.glb');

    let weaponGroup = null;

    world.ready.then(() => {
      const scene = world.scene;
      const camera = world.camera;

      weaponGroup = new THREE.Group();
      camera.add(weaponGroup);
      scene.add(camera);
      weaponGroup.position.set(0.5, -0.7, -1);
      weaponGroup.visible = false;

      const loader = new THREE.GLTFLoader();
      loader.load('build/assets/models/mel_portal_gun.glb', (gltf) => {
        const portalGun = gltf.scene;
        portalGun.scale.set(1.5, 1.5, 1.5);
        weaponGroup.add(portalGun);
      });
    });


    // *** PHOTON & CONSOLE SETUP (AFTER SKETCHBOOK INIT) ***

    // Photon Realtime App ID
    const photonAppId = "0e7ba88d-a481-481c-a32b-2e0dabaa8d7e";
    const photonClient = new Photon.LoadBalancing.LoadBalancingClient(photonAppId, "us");

    // Console elements
    const consoleEl = document.getElementById('console');
    const consoleOutput = document.getElementById('console-output');
    const consoleInput = document.getElementById('console-input');

    let consoleActive = false;
    let cheatsLevel = 0;

    function logToConsole(msg) {
      consoleOutput.textContent += msg + '\n';
      consoleOutput.scrollTop = consoleOutput.scrollHeight;
      console.log(msg);
    }

    function toggleConsole() {
      consoleActive = !consoleActive;
      consoleEl.style.display = consoleActive ? 'flex' : 'none';
      if (consoleActive) consoleInput.focus();
    }

    function handleCommand(cmd) {
      const args = cmd.trim().split(/\s+/);
      const command = args[0].toLowerCase();

      switch (command) {
        case 'sv_cheats':
          if (args.length < 2) {
            logToConsole('Usage: sv_cheats [0|1|2]');
            break;
          }
          const level = parseInt(args[1], 10);
          if ([0, 1, 2].includes(level)) {
            cheatsLevel = level;
            logToConsole(`sv_cheats set to ${level}`);
          } else {
            logToConsole('Invalid sv_cheats level. Use 0, 1, or 2.');
          }
          break;

        case 'toggleportalgun':
          if (weaponGroup) {
            weaponGroup.visible = !weaponGroup.visible;
            logToConsole(`Portal gun ${weaponGroup.visible ? 'enabled' : 'disabled'}`);
          }
          break;

        case 'noclip':
          if (cheatsLevel < 1) {
            logToConsole('noclip requires sv_cheats 1 or higher');
          } else {
            logToConsole('Noclip toggled (stub)');
            // TODO: implement noclip
          }
          break;

        case 'join':
          if (args.length < 2) {
            logToConsole('Usage: join [roomname]');
            break;
          }
          if (!photonClient.isInLobby()) {
            logToConsole('Must be in lobby to join a room.');
            break;
          }
          photonClient.joinRoom(args[1]).then(() => {
            logToConsole(`Joining room ${args[1]}...`);
          }).catch(e => {
            logToConsole(`Failed to join room: ${e.message || e}`);
          });
          break;

        case 'leave':
          if (!photonClient.isInRoom) {
            logToConsole('Not currently in a room.');
            break;
          }
          photonClient.leaveRoom().then(() => {
            logToConsole('Left room.');
          }).catch(e => {
            logToConsole(`Failed to leave room: ${e.message || e}`);
          });
          break;

        case 'host':
          if (args.length < 2) {
            logToConsole('Usage: host [roomname]');
            break;
          }
          if (!photonClient.isInLobby()) {
            logToConsole('Must be in lobby to host a room.');
            break;
          }
          photonClient.createRoom(args[1], { maxPlayers: 8 }).then(() => {
            logToConsole(`Hosting room ${args[1]}...`);
          }).catch(e => {
            logToConsole(`Failed to host room: ${e.message || e}`);
          });
          break;

        case 'help':
          logToConsole('Commands: sv_cheats, toggleportalgun, noclip, join [room], leave, host [room], help');
          break;

        default:
          logToConsole(`Unknown command: ${command}`);
      }
    }

    consoleInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        const cmd = consoleInput.value;
        consoleInput.value = '';
        logToConsole('> ' + cmd);
        handleCommand(cmd);
        e.preventDefault();
      }
    });

    window.addEventListener('keydown', (e) => {
      if (e.key === '`' || e.key === '~') {
        toggleConsole();
        e.preventDefault();
      } else if (!consoleActive && e.key.toLowerCase() === 'c') {
        if (weaponGroup) weaponGroup.visible = !weaponGroup.visible;
      }
    });

    photonClient.onStateChange = (state) => {
      logToConsole(`Photon State: ${Photon.LoadBalancing.ConnectionStateToName(state)}`);

      if (state === Photon.LoadBalancing.ConnectionState.ConnectedToMaster) {
        photonClient.joinLobby();
      }
      if (state === Photon.LoadBalancing.ConnectionState.JoinedLobby) {
        logToConsole('Joined lobby, ready for commands.');
      }
      if (state === Photon.LoadBalancing.ConnectionState.JoinedRoom) {
        logToConsole(`Joined room: ${photonClient.myRoomName}`);
      }
    };

    photonClient.connect();
  </script>
</body>
</html>
